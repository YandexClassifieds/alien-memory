# Layout

Layout - описание схемы данных, хранящихся в памяти. В основе лежит `java.lang.foreign.MemoryLayout`.

Схема собирается из кирпичиков:

- `Value` - элементарный слой для целых чисел, символов и т.д.
  ```scala
  val a = Values.Long //  слой под Long значения
  ```
- `BoundedSequence` - контейнер для последовательности данных одного типа.
  Упрощенно можно собирать последовательности с помощью оператора *, это повышает читабельность для матриц.
  ```scala
  val a = Values.Long * 2 * 5 // матрица с 5 строчками и 2 столбцами
  ```
- `Aligned` - контейнер группы данных, который задает выравнивание в байтах для нижележащих данных.
  ```scala
  val aligned = (Values.Long * 2 * 5).align[`2^8`] //  обеспечивает выделение памяти по адресу, кратному 256.
  ```
- `Padding` - "Пробел" в памяти, который не хранит данные, но добавляет смещение в байтах перед следующим элементом.

  ```scala
  val onlyPadding = Padding(32) // 32 пустых байта
  ```
- `Dynamic` - контейнер группы данных. Выделяются два типа: структуры и объединения.
  
  [Структуры](https://ru.wikipedia.org/wiki/Структура_(язык_Си)) записывают в память данные своих полей последовательно(
  то же самое что и struct из C).

  [Объединения](https://ru.wikipedia.org/wiki/Объединение_(структура_данных)) же могут содержать что-то одно из 2 (то же
  самое что и union из C)

  В alien для конструирования dynamic layout используются операторы:

  ```scala
  <>: - дополнение текущего объединения другим объединением

  >> - инициализация слоя: переданный в такой конструктор name := layout теперь считается структурой или обьеденением из одного элемента

  >>: - дополнение текущей структуры другой структурой
  ```

  Части структур и объединений нужно именовать с помощью оператора `:=`.
  Пример:

  ```scala
  val a = "matrix" := Values.Long * 7 * 2 // матрица с именем matrix
  val b = "array" := Values.Long * 5 // массив с именем array
  val layout: ("matrix" := BoundedSequence[BoundedSequence[Value[Long]]]) >>: 
              (>>["array" := BoundedSequence[Value[Long]]]) = a >>: b // структура из матрицы и массива
  ```

### Note

При построении `Layout` нужно учитывать, что действует обратная (правая) ассоциативность. Например, при создании
матрицы

```scala
val memL = "bitmap" := (Values.Long * height) * width
```

Сначала создается одна строка из height ячеек, затем эта строка масштабируется по ширине (width).